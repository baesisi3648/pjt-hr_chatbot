# 📚 ZIC-TALK 상세 가이드

이 문서는 시스템 아키텍처, 코드 구조, 개선 제안을 포함한 상세 가이드입니다.

---

## 📖 목차

1. [시스템 아키텍처](#-시스템-아키텍처)
2. [코드 구조 설명](#-코드-구조-설명)
3. [커스터마이징 가이드](#-커스터마이징-가이드)
4. [개선 제안](#-개선-제안)
5. [FAQ](#-faq)

---

## 🏗️ 시스템 아키텍처

### 전체 흐름도

```
┌─────────────────────────────────────────────────────────────┐
│                    1. 사용자 질문 입력                         │
│                 "그럼 월차는 어떻게 되나요?"                     │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│              2. 질문 재작성 (rewrite_question)                │
│  - 이전 대화 기록 참조 (최근 6개 메시지)                         │
│  - LLM으로 독립적인 질문으로 변환                               │
│  - "취업규칙에서 월차 휴가는 어떻게 되나요?"                     │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│              3. 규정 검색 (retrieve_context)                  │
│  - Pinecone 벡터 DB에서 유사도 검색                            │
│  - 상위 5개 관련 조항 추출                                      │
│  - 메타데이터 포함하여 컨텍스트 구성                             │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│              4. 답변 초안 생성 (generate_draft)                │
│  - 검색된 규정 + 질문으로 답변 작성                             │
│  - 조항 번호와 근거 포함                                        │
│  - 이전 대화 맥락도 참고                                        │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│              5. 팩트체크 (critique_answer)                    │
│  - 답변이 규정과 일치하는지 검증                                │
│  - PASS / FAIL 평가                                           │
└────────────────────┬────────────────────────────────────────┘
                     │
         ┌───────────┴───────────┐
         │                       │
    ✅ PASS                  ❌ FAIL
         │                       │
         │                       ▼
         │         ┌──────────────────────────┐
         │         │  6. 답변 재작성 (rewrite) │
         │         │   - 피드백 반영하여 수정   │
         │         │   - 최대 2회 반복         │
         │         └──────────┬───────────────┘
         │                    │
         │                    └─────────→ 5번으로
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│                    7. 최종 답변 반환                           │
└─────────────────────────────────────────────────────────────┘
```

---

## 💻 코드 구조 설명

### graph.py 주요 컴포넌트

#### 1. 설정 상수
```python
OPENAI_MODEL = "gpt-4o-mini"          # 사용할 GPT 모델
EMBEDDING_MODEL = "text-embedding-3-small"  # 임베딩 모델
RETRIEVER_K = 5                        # 검색할 문서 개수
MAX_CHAT_HISTORY = 6                   # 참고할 최근 대화 개수
MAX_REVISION_COUNT = 2                 # 최대 재작성 횟수
```

#### 2. 시스템 프롬프트
- `REWRITE_SYSTEM_PROMPT`: 질문 재작성 지침
- `DRAFT_SYSTEM_PROMPT`: 답변 작성 지침
- `CRITIQUE_SYSTEM_PROMPT`: 팩트체크 지침

#### 3. GraphState (상태 관리)
```python
class GraphState(TypedDict):
    question: str           # 변환된 질문
    original_question: str  # 원본 질문
    context: str            # 검색된 규정
    draft: str              # 답변 초안
    critique: str           # 검증 피드백
    grade: str              # PASS/FAIL
    revision_count: int     # 수정 횟수
    chat_history: List      # 대화 기록
```

#### 4. 노드 함수들
- `rewrite_question()`: 대화 맥락 반영한 질문 재작성
- `retrieve_context()`: 벡터 DB에서 관련 규정 검색
- `generate_draft()`: 초안 작성
- `critique_answer()`: 팩트체크
- `rewrite_answer()`: 답변 재작성
- `should_continue()`: 검증 통과 여부 판단

### app.py 주요 기능

#### 1. 유틸리티 함수
```python
get_timestamp()              # 현재 시간 반환
export_chat_to_txt()        # TXT 형식 내보내기
export_chat_to_json()       # JSON 형식 내보내기
```

#### 2. 세션 상태 관리
```python
st.session_state.messages       # 대화 기록
st.session_state.total_questions  # 질문 수
st.session_state.start_time     # 세션 시작 시간
```

#### 3. UI 컴포넌트
- 사이드바: 통계, 기능 안내, 내보내기
- 메인: 채팅 인터페이스
- 하단: 안내 메시지

---

## 🎨 커스터마이징 가이드

### 1. 모델 변경

**더 빠른 응답 (정확도 감소):**
```env
OPENAI_MODEL=gpt-3.5-turbo
```

**더 높은 정확도 (비용 증가):**
```env
OPENAI_MODEL=gpt-4
```

### 2. 검색 문서 개수 조정

**더 많은 컨텍스트:**
```env
RETRIEVER_K=10
```

**더 적은 토큰 사용:**
```env
RETRIEVER_K=3
```

### 3. 대화 기록 길이 조정

```env
MAX_CHAT_HISTORY=10  # 더 긴 맥락
MAX_CHAT_HISTORY=4   # 짧은 맥락
```

### 4. 재작성 횟수 조정

```env
MAX_REVISION_COUNT=3  # 더 엄격한 검증
MAX_REVISION_COUNT=1  # 빠른 응답
```

### 5. UI 색상 변경

`app.py`의 CSS 부분 수정:
```python
# 파란색 테마
background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);

# 녹색 테마
background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
```

### 6. 시스템 프롬프트 커스터마이징

`graph.py`의 프롬프트 변수를 수정하여 답변 스타일 조정 가능

---

## 💡 개선 제안

### 우선순위 높음 (1-2주 소요)

#### 1. 답변 평가 시스템
**목적**: 사용자 피드백 수집

**구현 방법**:
```python
# app.py에 추가
col1, col2 = st.columns([1, 1])
with col1:
    if st.button("👍 도움됨"):
        save_feedback(msg_id, "positive")
with col2:
    if st.button("👎 도움안됨"):
        save_feedback(msg_id, "negative")
```

**효과**: 답변 품질 개선, 문제 패턴 파악

---

#### 2. 검색 조항 표시
**목적**: 답변 근거 투명화

**구현 방법**:
```python
with st.expander("📚 참고한 규정 조항"):
    for doc in retrieved_docs:
        st.markdown(f"**{doc.metadata['article_title']}**")
        st.text(doc.page_content[:200] + "...")
```

**효과**: 신뢰도 향상, 사용자가 직접 확인 가능

---

#### 3. 즐겨찾기 기능
**목적**: 자주 묻는 질문 빠른 접근

**구현 방법**:
```python
FAQs = [
    "연차는 얼마나 주나요?",
    "퇴직금 계산 방법은?",
    "육아휴직 조건은?"
]

for faq in FAQs:
    if st.button(faq):
        # 자동으로 질문 입력
        st.session_state.current_question = faq
```

**효과**: UX 향상, 신규 사용자 가이드

---

### 우선순위 중간 (1-2개월 소요)

#### 4. 다중 문서 지원
**목적**: 취업규칙 외 추가 문서 검색

**구현 방법**:
- Pinecone namespace 분리
- 문서 선택 UI 추가
- 메타데이터 필터링

**효과**: 활용도 증대

---

#### 5. 관리자 대시보드
**목적**: 사용 통계 및 분석

**주요 기능**:
- 일별/월별 질문 수
- 인기 질문 Top 10
- 평균 응답 시간
- 사용자 만족도

**구현**: `admin.py` 별도 파일 생성

---

#### 6. 카테고리별 검색
**목적**: 특정 주제 빠른 검색

**카테고리**:
- 휴가 (연차, 월차, 병가)
- 급여 (기본급, 수당, 퇴직금)
- 복리후생
- 근무 조건

**구현**: 메타데이터 기반 필터링

---

### 우선순위 낮음 (3개월+ 소요)

#### 7. 음성 입출력
- STT: Whisper API
- TTS: OpenAI TTS API
- 구현 난이도: 높음

#### 8. 다국어 지원
- 영어, 중국어 등
- 번역 + 검색 + 역번역
- 구현 난이도: 매우 높음

#### 9. 모바일 앱
- React Native
- 푸시 알림
- 구현 난이도: 매우 높음

---

## 🔥 성능 최적화 팁

### 1. 응답 속도 개선

**방법 1: 검증 횟수 줄이기**
```env
MAX_REVISION_COUNT=1
```

**방법 2: 더 빠른 모델 사용**
```env
OPENAI_MODEL=gpt-3.5-turbo
```

**방법 3: 검색 문서 수 줄이기**
```env
RETRIEVER_K=3
```

### 2. 비용 절감

**방법 1: 토큰 사용 최소화**
- 대화 기록 길이 줄이기
- 검색 문서 수 줄이기

**방법 2: 저렴한 모델 사용**
```env
OPENAI_MODEL=gpt-3.5-turbo
```

### 3. 정확도 향상

**방법 1: 더 많은 검증**
```env
MAX_REVISION_COUNT=3
```

**방법 2: 더 많은 컨텍스트**
```env
RETRIEVER_K=10
```

---

## ❓ FAQ

### Q1. 응답이 너무 느려요
**A**: 정상입니다. 3중 검증으로 10-15초 소요됩니다. 빠른 응답이 필요하면 `MAX_REVISION_COUNT=1` 또는 `gpt-3.5-turbo` 사용

### Q2. 대화 맥락을 인식하지 못해요
**A**: 
- 브라우저 새로고침 시 세션 초기화됨
- "대화 기록 초기화" 버튼을 눌렀는지 확인
- 질문이 너무 애매하지 않은지 확인

### Q3. 규정에 없는 내용을 답변해요
**A**: 
- 팩트체크가 통과한 것이므로 규정을 다시 확인
- `MAX_REVISION_COUNT`를 늘려 더 엄격하게 검증
- 문제가 반복되면 시스템 프롬프트 수정 필요

### Q4. API 비용이 많이 나와요
**A**:
- `gpt-3.5-turbo` 사용
- `RETRIEVER_K` 줄이기
- `MAX_CHAT_HISTORY` 줄이기
- 불필요한 재작성 줄이기

### Q5. 규정 업데이트는 어떻게 하나요?
**A**:
1. `rules.txt` 파일 수정
2. `python ingest.py` 다시 실행
3. Pinecone에 자동으로 업데이트됨

### Q6. Pinecone 무료 플랜으로 충분한가요?
**A**: 
- 무료 플랜: 10만 벡터, 1개 인덱스
- 취업규칙 ~100개 조항이면 충분함
- 여러 문서 추가 시 유료 플랜 필요

---

## 🛠️ 트러블슈팅

### 문제: `ModuleNotFoundError`
```bash
pip install -r requirements.txt
```

### 문제: Pinecone 인덱스 없음
```bash
# Pinecone 대시보드에서 인덱스 생성
# Dimension: 1536 (text-embedding-3-small)
# Metric: cosine
```

### 문제: 메모리 부족
- `RETRIEVER_K` 줄이기
- 대화 기록 정리
- 서버 재시작

---

## 📞 지원

추가 질문이나 문제가 있으면:
1. 환경 변수 확인 (`.env`)
2. API 키 유효성 확인
3. Pinecone 인덱스 상태 확인
4. 로그 메시지 확인

---

**작성일**: 2025-01-07  
**버전**: v2.0  
**다음 업데이트**: v2.1 (답변 평가, 검색 조항 표시)